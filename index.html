<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ground Assault Army Builder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { padding: 2rem; }
    .unit-table th, .unit-table td { vertical-align: middle; }
    .btn-group .btn.active { background-color: #0d6efd; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Ground Assault Army Builder</h2>
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="faction" class="form-label">Faction</label>
        <select id="faction" class="form-select">
          <option value="" disabled selected>Choose Army</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Point Limit</label><br />
        <div class="btn-group" role="group" id="point-buttons">
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(300)">300</button>
          <button type="button" class="btn btn-outline-primary active" onclick="setPointLimit(600)">600</button>
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(900)">900</button>
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(1200)">1200</button>
        </div>
        <div id="selected-limit" class="mt-2 fw-bold">Selected Point Limit: 600</div>
      </div>
    </div>

    <h4>Ground Units (Common)</h4>
    <select class="form-select mb-3" id="common-units">
      <option value="" disabled selected>Select a Unit</option>
    </select>

    <h4>Ground Units (Rare)</h4>
    <select class="form-select mb-3" id="rare-units">
      <option value="" disabled selected>Select a Unit</option>
    </select>

    <h4>UR Ground Units (Common)</h4>
    <select class="form-select mb-3" id="ur-common-units">
      <option value="" disabled selected>Select a Unit</option>
    </select>

    <h4>UR Ground Units (Rare)</h4>
    <select class="form-select mb-3" id="ur-rare-units">
      <option value="" disabled selected>Select a Unit</option>
    </select>

    <h4>Army List</h4>
    <table class="table table-striped">
      <thead>
        <tr><th>Unit</th><th>Cost</th><th>Rarity</th><th></th></tr>
      </thead>
      <tbody id="army-list-body"></tbody>
      <tfoot>
        <tr><td><strong>Total:</strong></td><td id="total-cost">0</td><td></td><td></td></tr>
      </tfoot>
    </table>

    <button class="btn btn-dark" onclick="exportToPDF()">Export to PDF</button>
  </div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1fofK8kEvGMV7-ZGSWdJHExhFU0iBBaE3XpzNSucHlpg/gviz/tq?tqx=out:csv";

    let allUnits = [];
    let filteredUnits = [];
    let armyList = [];
    let currentFaction = "";
    let pointLimit = 600;

    async function fetchUnits() {
      const res = await fetch(SHEET_URL);
      const csv = await res.text();

      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          allUnits = results.data
            .map(unit => ({
              Name: unit.Name,
              Cost: parseInt(unit.Cost),
              Type: unit.Type,
              Rarity: unit.Rarity,
              Faction: unit.Faction
            }))
            .filter(unit => unit.Name && unit.Faction && !isNaN(unit.Cost));

          const factions = [...new Set(allUnits.map(u => u.Faction).filter(f => f !== "UR"))];
          const select = document.getElementById("faction");
          select.innerHTML = '<option value="" disabled selected>Choose Army</option>';
          factions.forEach(f => {
            const option = document.createElement("option");
            option.value = f;
            option.textContent = f;
            select.appendChild(option);
          });

          select.addEventListener("change", e => {
            currentFaction = e.target.value;
            armyList = [];
            render();
          });
        },
        error: function(err) {
          alert("Failed to load unit data. Please check your sheet.");
          console.error("CSV Parse Error", err);
        }
      });
    }

    function setPointLimit(limit) {
      pointLimit = limit;
      document.getElementById("selected-limit").innerText = `Selected Point Limit: ${limit}`;
      document.querySelectorAll("#point-buttons .btn").forEach(btn => {
        btn.classList.remove("active");
        if (btn.textContent == limit.toString()) btn.classList.add("active");
      });
      render();
    }

    function render() {
      filteredUnits = allUnits.filter(u => u.Faction === currentFaction || u.Faction === "UR");
      const commonDropdown = document.getElementById("common-units");
      const rareDropdown = document.getElementById("rare-units");
      const urCommonDropdown = document.getElementById("ur-common-units");
      const urRareDropdown = document.getElementById("ur-rare-units");

      [commonDropdown, rareDropdown, urCommonDropdown, urRareDropdown].forEach(drop => drop.innerHTML = '<option value="" disabled selected>Select a Unit</option>');

      filteredUnits.forEach((unit, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${unit.Name} | ${unit.Type} | ${unit.Cost}`;
        if (unit.Faction === "UR") {
          if (unit.Rarity.toLowerCase() === "common") urCommonDropdown.appendChild(opt);
          else urRareDropdown.appendChild(opt);
        } else {
          if (unit.Rarity.toLowerCase() === "common") commonDropdown.appendChild(opt);
          else rareDropdown.appendChild(opt);
        }
      });

      [commonDropdown, rareDropdown, urCommonDropdown, urRareDropdown].forEach(drop => {
        drop.onchange = (e) => {
          const index = parseInt(e.target.value);
          addUnit(index);
          drop.selectedIndex = 0;
        };
      });

      const listBody = document.getElementById("army-list-body");
      listBody.innerHTML = "";
      let total = 0;
      armyList.forEach((unit, i) => {
        total += unit.Cost;
        listBody.insertAdjacentHTML("beforeend", `<tr><td>${unit.Name}</td><td>${unit.Cost}</td><td>${unit.Rarity}</td><td><button class='btn btn-sm btn-danger' onclick='removeUnit(${i})'>Remove</button></td></tr>`);
      });
      document.getElementById("total-cost").innerText = total;
    }

    function addUnit(index) {
      const unit = filteredUnits[index];
      const total = armyList.reduce((sum, u) => sum + u.Cost, 0);
      const isRare = unit.Rarity.toLowerCase() === "rare";
      const rareCount = armyList.filter(u => u.Rarity.toLowerCase() === "rare").length;
      const commonCount = armyList.filter(u => u.Rarity.toLowerCase() === "common").length;
      const suitCount = armyList.filter(u => u.Type.toLowerCase() === "suit").length;
      const maxUnits = Math.floor((pointLimit / 600) * 15);
      const requiredSuits = Math.floor(pointLimit / 600) * 3;
      const urCount = armyList.filter(u => u.Faction === "UR").length;
      const maxUR = Math.floor(pointLimit / 600) * 5;

      if (total + unit.Cost > pointLimit) return alert("Point limit exceeded!");
      if (armyList.length >= maxUnits) return alert(`Max unit count (${maxUnits}) reached.`);
      if (isRare && rareCount + 1 > commonCount) return alert("You cannot have more Rare units than Common units.");
      if (unit.Type.toLowerCase() !== "suit" && suitCount < requiredSuits && armyList.length + 1 === maxUnits)
        return alert(`You must include at least ${requiredSuits} Suit units.`);
      if (unit.Faction === "UR") {
        if (urCount >= maxUR) return alert(`No more than ${maxUR} UR units allowed.`);
        if (urCount >= suitCount) return alert("UR units must not exceed the number of Suit units.");
      }

      armyList.push(unit);
      render();
    }

    function removeUnit(index) {
      armyList.splice(index, 1);
      render();
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Ground Assault Army List", 20, 20);
      let y = 30;
      armyList.forEach(unit => {
        doc.text(`${unit.Name} - ${unit.Cost} pts (${unit.Rarity})`, 20, y);
        y += 10;
      });
      doc.text(`Total: ${armyList.reduce((sum, u) => sum + u.Cost, 0)} pts`, 20, y + 10);
      doc.save("ground-assault-army.pdf");
    }

    fetchUnits();
  </script>
</body>
</html>
