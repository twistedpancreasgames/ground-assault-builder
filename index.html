<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ground Assault Army Builder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { padding: 2rem; }
    .unit-table th, .unit-table td { vertical-align: middle; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Ground Assault Army Builder</h2>
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="faction" class="form-label">Faction</label>
        <select id="faction" class="form-select"></select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Point Limit</label><br />
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(300)">300</button>
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(600)">600</button>
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(900)">900</button>
          <button type="button" class="btn btn-outline-primary" onclick="setPointLimit(1200)">1200</button>
        </div>
        <div id="selected-limit" class="mt-2 fw-bold"></div>
      </div>
    </div>

    <h4>Add Units</h4>
    <table class="table unit-table table-bordered">
      <thead>
        <tr>
          <th>Unit</th>
          <th>Cost</th>
          <th>Type</th>
          <th>Wounds</th>
          <th>Rarity</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="unit-table-body"></tbody>
    </table>

    <h4>Army List</h4>
    <table class="table table-striped">
      <thead>
        <tr><th>Unit</th><th>Cost</th></tr>
      </thead>
      <tbody id="army-list-body"></tbody>
      <tfoot>
        <tr><td><strong>Total:</strong></td><td id="total-cost">0</td></tr>
      </tfoot>
    </table>

    <button class="btn btn-dark" onclick="exportToPDF()">Export to PDF</button>
  </div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1fofK8kEvGMV7-ZGSWdJHExhFU0iBBaE3XpzNSucHlpg/gviz/tq?tqx=out:csv";

    let allUnits = [];
    let filteredUnits = [];
    let armyList = [];
    let currentFaction = "";
    let pointLimit = 0;

    async function fetchUnits() {
      const res = await fetch(SHEET_URL);
      const csv = await res.text();

      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          allUnits = results.data.map(unit => ({
            Name: unit.Name,
            Cost: parseInt(unit.Cost),
            Type: unit.Type,
            Wounds: parseInt(unit.Wounds),
            Rarity: unit.Rarity,
            Faction: unit.Faction
          }));

          const factions = [...new Set(allUnits.map(u => u.Faction))];
          const select = document.getElementById("faction");
          select.innerHTML = factions.map(f => `<option value="${f}">${f}</option>`).join('');
          currentFaction = factions[0];
          select.value = currentFaction;

          select.addEventListener("change", e => {
            currentFaction = e.target.value;
            render();
          });

          render();
        },
        error: function(err) {
          alert("Failed to load unit data. Please check your sheet.");
          console.error("CSV Parse Error", err);
        }
      });
    }

    function setPointLimit(limit) {
      pointLimit = limit;
      document.getElementById("selected-limit").innerText = `Selected Point Limit: ${limit}`;
      render();
    }

    function render() {
      filteredUnits = allUnits.filter(u => u.Faction === currentFaction);
      const tbody = document.getElementById("unit-table-body");
      tbody.innerHTML = "";
      filteredUnits.forEach((unit, i) => {
        tbody.insertAdjacentHTML("beforeend", `<tr>
          <td>${unit.Name}</td>
          <td>${unit.Cost}</td>
          <td>${unit.Type}</td>
          <td>${unit.Wounds}</td>
          <td>${unit.Rarity}</td>
          <td><button class="btn btn-sm btn-primary" onclick="addUnit(${i})">Add</button></td>
        </tr>`);
      });

      const listBody = document.getElementById("army-list-body");
      listBody.innerHTML = "";
      let total = 0;
      armyList.forEach(unit => {
        total += unit.Cost;
        listBody.insertAdjacentHTML("beforeend", `<tr><td>${unit.Name}</td><td>${unit.Cost}</td></tr>`);
      });
      document.getElementById("total-cost").innerText = total;
    }

    function addUnit(index) {
      const unit = filteredUnits[index];
      const total = armyList.reduce((sum, u) => sum + u.Cost, 0);
      if (total + unit.Cost <= pointLimit) {
        armyList.push(unit);
        render();
      } else {
        alert("Point limit exceeded!");
      }
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Ground Assault Army List", 20, 20);
      let y = 30;
      armyList.forEach(unit => {
        doc.text(`${unit.Name} - ${unit.Cost} pts`, 20, y);
        y += 10;
      });
      doc.text(`Total: ${armyList.reduce((sum, u) => sum + u.Cost, 0)} pts`, 20, y + 10);
      doc.save("ground-assault-army.pdf");
    }

    fetchUnits();
  </script>
</body>
</html>
